\chapter{Indexed\+DB with usability.}
\hypertarget{md_node__modules_2idb_2README}{}\label{md_node__modules_2idb_2README}\index{IndexedDB with usability.@{IndexedDB with usability.}}
\label{md_node__modules_2idb_2README_autotoc_md15378}%
\Hypertarget{md_node__modules_2idb_2README_autotoc_md15378}%
 This is a tiny (\texorpdfstring{$\sim$}{\string~}1.06kB brotli\textquotesingle{}d) library that mostly mirrors the Indexed\+DB API, but with small improvements that make a big difference to usability.


\begin{DoxyEnumerate}
\item \doxylink{md_node__modules_2web-vitals_2README_installation}{Installation}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Changes
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Browser support
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item API
\begin{DoxyEnumerate}
\item \`{}open\+DB\`{}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \`{}delete\+DB\`{}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \`{}unwrap\`{}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \`{}wrap\`{}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item General enhancements
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \`{}\+IDBDatabase\`{} enhancements
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \`{}\+IDBTransaction\`{} enhancements
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \`{}\+IDBCursor\`{} enhancements
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Async iterators
\end{DoxyEnumerate}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Examples
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item Type\+Script
\end{DoxyEnumerate}\hypertarget{md_node__modules_2idb_2README_autotoc_md15379}{}\doxysection{\texorpdfstring{Installation}{Installation}}\label{md_node__modules_2idb_2README_autotoc_md15379}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15380}{}\doxysubsection{\texorpdfstring{Using npm}{Using npm}}\label{md_node__modules_2idb_2README_autotoc_md15380}

\begin{DoxyCode}{0}
\DoxyCodeLine{npm\ install\ idb}

\end{DoxyCode}


Then, assuming you\textquotesingle{}re using a module-\/compatible system (like webpack, Rollup etc)\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{import\ \{\ openDB,\ deleteDB,\ wrap,\ unwrap\ \}\ from\ 'idb';}
\DoxyCodeLine{}
\DoxyCodeLine{async\ function\ doDatabaseStuff()\ \{}
\DoxyCodeLine{\ \ const\ db\ =\ await\ openDB(…);}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15381}{}\doxysubsection{\texorpdfstring{Directly in a browser}{Directly in a browser}}\label{md_node__modules_2idb_2README_autotoc_md15381}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15382}{}\doxysubsubsection{\texorpdfstring{Using the modules method directly via jsdelivr\+:}{Using the modules method directly via jsdelivr:}}\label{md_node__modules_2idb_2README_autotoc_md15382}

\begin{DoxyCode}{0}
\DoxyCodeLine{<script\ type="{}module"{}>}
\DoxyCodeLine{\ \ import\ \{\ openDB,\ deleteDB,\ wrap,\ unwrap\ \}\ from\ 'https://cdn.jsdelivr.net/npm/idb@7/+esm';}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ async\ function\ doDatabaseStuff()\ \{}
\DoxyCodeLine{\ \ \ \ const\ db\ =\ await\ openDB(…);}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{</script>}

\end{DoxyCode}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15383}{}\doxysubsubsection{\texorpdfstring{Using external script reference}{Using external script reference}}\label{md_node__modules_2idb_2README_autotoc_md15383}

\begin{DoxyCode}{0}
\DoxyCodeLine{<script\ src="{}https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"{}></script>}
\DoxyCodeLine{<script>}
\DoxyCodeLine{\ \ async\ function\ doDatabaseStuff()\ \{}
\DoxyCodeLine{\ \ \ \ const\ db\ =\ await\ idb.openDB(…);}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{</script>}

\end{DoxyCode}


A global, {\ttfamily idb}, will be created, containing all exports of the module version.\hypertarget{md_node__modules_2idb_2README_autotoc_md15384}{}\doxysection{\texorpdfstring{Changes}{Changes}}\label{md_node__modules_2idb_2README_autotoc_md15384}
\doxysectlink{md_node__modules_2idb_2CHANGELOG}{See details of (potentially) breaking changes}{0}.\hypertarget{md_node__modules_2idb_2README_autotoc_md15385}{}\doxysection{\texorpdfstring{Browser support}{Browser support}}\label{md_node__modules_2idb_2README_autotoc_md15385}
This library targets modern browsers, as in Chrome, Firefox, Safari, and other browsers that use those engines, such as Edge. IE is not supported.

If you want to target much older versions of those browsers, you can transpile the library using something like \href{https://babeljs.io/}{\texttt{ Babel}}. You can\textquotesingle{}t transpile the library for IE, as it relies on a proper implementation of \href{https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy}{\texttt{ Java\+Script proxies}}.\hypertarget{md_node__modules_2idb_2README_autotoc_md15386}{}\doxysection{\texorpdfstring{API}{API}}\label{md_node__modules_2idb_2README_autotoc_md15386}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15387}{}\doxysubsection{\texorpdfstring{$<$tt$>$open\+DB$<$/tt$>$}{<tt>openDB</tt>}}\label{md_node__modules_2idb_2README_autotoc_md15387}
This method opens a database, and returns a promise for an enhanced \href{https://w3c.github.io/IndexedDB/\#database-interface}{\texttt{ {\ttfamily IDBDatabase}}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ db\ =\ await\ openDB(name,\ version,\ \{}
\DoxyCodeLine{\ \ upgrade(db,\ oldVersion,\ newVersion,\ transaction,\ event)\ \{}
\DoxyCodeLine{\ \ \ \ //\ …}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\ \ blocked(currentVersion,\ blockedVersion,\ event)\ \{}
\DoxyCodeLine{\ \ \ \ //\ …}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\ \ blocking(currentVersion,\ blockedVersion,\ event)\ \{}
\DoxyCodeLine{\ \ \ \ //\ …}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\ \ terminated()\ \{}
\DoxyCodeLine{\ \ \ \ //\ …}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\});}

\end{DoxyCode}



\begin{DoxyItemize}
\item {\ttfamily name}\+: Name of the database.
\item {\ttfamily version} (optional)\+: Schema version, or {\ttfamily undefined} to open the current version.
\item {\ttfamily upgrade} (optional)\+: Called if this version of the database has never been opened before. Use it to specify the schema for the database. This is similar to the \href{https://developer.mozilla.org/en-US/docs/Web/API/IDBOpenDBRequest/upgradeneeded_event}{\texttt{ {\ttfamily upgradeneeded} event}} in plain Indexed\+DB.
\begin{DoxyItemize}
\item {\ttfamily db}\+: An enhanced {\ttfamily IDBDatabase}.
\item {\ttfamily old\+Version}\+: Last version of the database opened by the user.
\item {\ttfamily new\+Version}\+: Whatever new version you provided.
\item {\ttfamily transaction}\+: An enhanced transaction for this upgrade. This is useful if you need to get data from other stores as part of a migration.
\item {\ttfamily event}\+: The event object for the associated {\ttfamily upgradeneeded} event.
\end{DoxyItemize}
\item {\ttfamily blocked} (optional)\+: Called if there are older versions of the database open on the origin, so this version cannot open. This is similar to the \href{https://developer.mozilla.org/en-US/docs/Web/API/IDBOpenDBRequest/blocked_event}{\texttt{ {\ttfamily blocked} event}} in plain Indexed\+DB.
\begin{DoxyItemize}
\item {\ttfamily current\+Version}\+: Version of the database that\textquotesingle{}s blocking this one.
\item {\ttfamily blocked\+Version}\+: The version of the database being blocked (whatever version you provided to {\ttfamily open\+DB}).
\item {\ttfamily event}\+: The event object for the associated {\ttfamily blocked} event.
\end{DoxyItemize}
\item {\ttfamily blocking} (optional)\+: Called if this connection is blocking a future version of the database from opening. This is similar to the \href{https://developer.mozilla.org/en-US/docs/Web/API/IDBDatabase/versionchange_event}{\texttt{ {\ttfamily versionchange} event}} in plain Indexed\+DB.
\begin{DoxyItemize}
\item {\ttfamily current\+Version}\+: Version of the open database (whatever version you provided to {\ttfamily open\+DB}).
\item {\ttfamily blocked\+Version}\+: The version of the database that\textquotesingle{}s being blocked.
\item {\ttfamily event}\+: The event object for the associated {\ttfamily versionchange} event.
\end{DoxyItemize}
\item {\ttfamily terminated} (optional)\+: Called if the browser abnormally terminates the connection, but not on regular closures like calling {\ttfamily db.\+close()}. This is similar to the \href{https://developer.mozilla.org/en-US/docs/Web/API/IDBDatabase/close_event}{\texttt{ {\ttfamily close} event}} in plain Indexed\+DB.
\end{DoxyItemize}\hypertarget{md_node__modules_2idb_2README_autotoc_md15388}{}\doxysubsection{\texorpdfstring{$<$tt$>$delete\+DB$<$/tt$>$}{<tt>deleteDB</tt>}}\label{md_node__modules_2idb_2README_autotoc_md15388}
Deletes a database.


\begin{DoxyCode}{0}
\DoxyCodeLine{await\ deleteDB(name,\ \{}
\DoxyCodeLine{\ \ blocked()\ \{}
\DoxyCodeLine{\ \ \ \ //\ …}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\});}

\end{DoxyCode}



\begin{DoxyItemize}
\item {\ttfamily name}\+: Name of the database.
\item {\ttfamily blocked} (optional)\+: Called if the database already exists and there are open connections that don’t close in response to a versionchange event, the request will be blocked until they all close.
\begin{DoxyItemize}
\item {\ttfamily current\+Version}\+: Version of the database that\textquotesingle{}s blocking the delete operation.
\item {\ttfamily event}\+: The event object for the associated \textquotesingle{}versionchange\textquotesingle{} event.
\end{DoxyItemize}
\end{DoxyItemize}\hypertarget{md_node__modules_2idb_2README_autotoc_md15389}{}\doxysubsection{\texorpdfstring{$<$tt$>$unwrap$<$/tt$>$}{<tt>unwrap</tt>}}\label{md_node__modules_2idb_2README_autotoc_md15389}
Takes an enhanced Indexed\+DB object and returns the plain unmodified one.


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ unwrapped\ =\ unwrap(wrapped);}

\end{DoxyCode}


This is useful if, for some reason, you want to drop back into plain Indexed\+DB. Promises will also be converted back into {\ttfamily IDBRequest} objects.\hypertarget{md_node__modules_2idb_2README_autotoc_md15390}{}\doxysubsection{\texorpdfstring{$<$tt$>$wrap$<$/tt$>$}{<tt>wrap</tt>}}\label{md_node__modules_2idb_2README_autotoc_md15390}
Takes an IDB object and returns a version enhanced by this library.


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ wrapped\ =\ wrap(unwrapped);}

\end{DoxyCode}


This is useful if some third party code gives you an {\ttfamily IDBDatabase} object and you want it to have the features of this library.

This doesn\textquotesingle{}t work with {\ttfamily IDBCursor}, \href{https://github.com/w3c/IndexedDB/issues/255}{\texttt{ due to missing primitives}}. Also, if you wrap an {\ttfamily IDBTransaction}, {\ttfamily tx.\+store} and {\ttfamily tx.\+object\+Store\+Names} won\textquotesingle{}t work in Edge. To avoid these issues, wrap the {\ttfamily IDBDatabase} object, and use the wrapped object to create a new transaction.\hypertarget{md_node__modules_2idb_2README_autotoc_md15391}{}\doxysubsection{\texorpdfstring{General enhancements}{General enhancements}}\label{md_node__modules_2idb_2README_autotoc_md15391}
Once you\textquotesingle{}ve opened the database the API is the same as Indexed\+DB, except for a few changes to make things easier.

Firstly, any method that usually returns an {\ttfamily IDBRequest} object will now return a promise for the result.


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ store\ =\ db.transaction(storeName).objectStore(storeName);}
\DoxyCodeLine{const\ value\ =\ await\ store.get(key);}

\end{DoxyCode}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15392}{}\doxysubsubsection{\texorpdfstring{Promises \& throwing}{Promises \& throwing}}\label{md_node__modules_2idb_2README_autotoc_md15392}
The library turns all {\ttfamily IDBRequest} objects into promises, but it doesn\textquotesingle{}t know in advance which methods may return promises.

As a result, methods such as {\ttfamily store.\+put} may throw instead of returning a promise.

If you\textquotesingle{}re using async functions, there\textquotesingle{}s no observable difference.\hypertarget{md_node__modules_2idb_2README_autotoc_md15393}{}\doxysubsubsection{\texorpdfstring{Transaction lifetime}{Transaction lifetime}}\label{md_node__modules_2idb_2README_autotoc_md15393}
TL;DR\+: {\bfseries{Do not {\ttfamily await} other things between the start and end of your transaction}}, otherwise the transaction will close before you\textquotesingle{}re done.

An IDB transaction auto-\/closes if it doesn\textquotesingle{}t have anything left do once microtasks have been processed. As a result, this works fine\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ tx\ =\ db.transaction('keyval',\ 'readwrite');}
\DoxyCodeLine{const\ store\ =\ tx.objectStore('keyval');}
\DoxyCodeLine{const\ val\ =\ (await\ store.get('counter'))\ ||\ 0;}
\DoxyCodeLine{await\ store.put(val\ +\ 1,\ 'counter');}
\DoxyCodeLine{await\ tx.done;}

\end{DoxyCode}


But this doesn\textquotesingle{}t\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ tx\ =\ db.transaction('keyval',\ 'readwrite');}
\DoxyCodeLine{const\ store\ =\ tx.objectStore('keyval');}
\DoxyCodeLine{const\ val\ =\ (await\ store.get('counter'))\ ||\ 0;}
\DoxyCodeLine{//\ This\ is\ where\ things\ go\ wrong:}
\DoxyCodeLine{const\ newVal\ =\ await\ fetch('/increment?val='\ +\ val);}
\DoxyCodeLine{//\ And\ this\ throws\ an\ error:}
\DoxyCodeLine{await\ store.put(newVal,\ 'counter');}
\DoxyCodeLine{await\ tx.done;}

\end{DoxyCode}


In this case, the transaction closes while the browser is fetching, so {\ttfamily store.\+put} fails.\hypertarget{md_node__modules_2idb_2README_autotoc_md15394}{}\doxysubsection{\texorpdfstring{$<$tt$>$\+IDBDatabase$<$/tt$>$ enhancements}{<tt>IDBDatabase</tt> enhancements}}\label{md_node__modules_2idb_2README_autotoc_md15394}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15395}{}\doxysubsubsection{\texorpdfstring{Shortcuts to get/set from an object store}{Shortcuts to get/set from an object store}}\label{md_node__modules_2idb_2README_autotoc_md15395}
It\textquotesingle{}s common to create a transaction for a single action, so helper methods are included for this\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{//\ Get\ a\ value\ from\ a\ store:}
\DoxyCodeLine{const\ value\ =\ await\ db.get(storeName,\ key);}
\DoxyCodeLine{//\ Set\ a\ value\ in\ a\ store:}
\DoxyCodeLine{await\ db.put(storeName,\ value,\ key);}

\end{DoxyCode}


The shortcuts are\+: {\ttfamily get}, {\ttfamily get\+Key}, {\ttfamily get\+All}, {\ttfamily get\+All\+Keys}, {\ttfamily count}, {\ttfamily put}, {\ttfamily add}, {\ttfamily delete}, and {\ttfamily clear}. Each method takes a {\ttfamily store\+Name} argument, the name of the object store, and the rest of the arguments are the same as the equivalent {\ttfamily IDBObject\+Store} method.\hypertarget{md_node__modules_2idb_2README_autotoc_md15396}{}\doxysubsubsection{\texorpdfstring{Shortcuts to get from an index}{Shortcuts to get from an index}}\label{md_node__modules_2idb_2README_autotoc_md15396}
The shortcuts are\+: {\ttfamily get\+From\+Index}, {\ttfamily get\+Key\+From\+Index}, {\ttfamily get\+All\+From\+Index}, {\ttfamily get\+All\+Keys\+From\+Index}, and {\ttfamily count\+From\+Index}.


\begin{DoxyCode}{0}
\DoxyCodeLine{//\ Get\ a\ value\ from\ an\ index:}
\DoxyCodeLine{const\ value\ =\ await\ db.getFromIndex(storeName,\ indexName,\ key);}

\end{DoxyCode}


Each method takes {\ttfamily store\+Name} and {\ttfamily index\+Name} arguments, followed by the rest of the arguments from the equivalent {\ttfamily IDBIndex} method.\hypertarget{md_node__modules_2idb_2README_autotoc_md15397}{}\doxysubsection{\texorpdfstring{$<$tt$>$\+IDBTransaction$<$/tt$>$ enhancements}{<tt>IDBTransaction</tt> enhancements}}\label{md_node__modules_2idb_2README_autotoc_md15397}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15398}{}\doxysubsubsection{\texorpdfstring{$<$tt$>$tx.\+store$<$/tt$>$}{<tt>tx.store</tt>}}\label{md_node__modules_2idb_2README_autotoc_md15398}
If a transaction involves a single store, the {\ttfamily store} property will reference that store.


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ tx\ =\ db.transaction('whatever');}
\DoxyCodeLine{const\ store\ =\ tx.store;}

\end{DoxyCode}


If a transaction involves multiple stores, {\ttfamily tx.\+store} is undefined, you need to use {\ttfamily tx.\+object\+Store(store\+Name)} to get the stores.\hypertarget{md_node__modules_2idb_2README_autotoc_md15399}{}\doxysubsubsection{\texorpdfstring{$<$tt$>$tx.\+done$<$/tt$>$}{<tt>tx.done</tt>}}\label{md_node__modules_2idb_2README_autotoc_md15399}
Transactions have a {\ttfamily .done} promise which resolves when the transaction completes successfully, and otherwise rejects with the \href{https://developer.mozilla.org/en-US/docs/Web/API/IDBTransaction/error}{\texttt{ transaction error}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ tx\ =\ db.transaction(storeName,\ 'readwrite');}
\DoxyCodeLine{await\ Promise.all([}
\DoxyCodeLine{\ \ tx.store.put('bar',\ 'foo'),}
\DoxyCodeLine{\ \ tx.store.put('world',\ 'hello'),}
\DoxyCodeLine{\ \ tx.done,}
\DoxyCodeLine{]);}

\end{DoxyCode}


If you\textquotesingle{}re writing to the database, {\ttfamily tx.\+done} is the signal that everything was successfully committed to the database. However, it\textquotesingle{}s still beneficial to await the individual operations, as you\textquotesingle{}ll see the error that caused the transaction to fail.\hypertarget{md_node__modules_2idb_2README_autotoc_md15400}{}\doxysubsection{\texorpdfstring{$<$tt$>$\+IDBCursor$<$/tt$>$ enhancements}{<tt>IDBCursor</tt> enhancements}}\label{md_node__modules_2idb_2README_autotoc_md15400}
Cursor advance methods ({\ttfamily advance}, {\ttfamily continue}, {\ttfamily continue\+Primary\+Key}) return a promise for the cursor, or null if there are no further values to provide.


\begin{DoxyCode}{0}
\DoxyCodeLine{let\ cursor\ =\ await\ db.transaction(storeName).store.openCursor();}
\DoxyCodeLine{}
\DoxyCodeLine{while\ (cursor)\ \{}
\DoxyCodeLine{\ \ console.log(cursor.key,\ cursor.value);}
\DoxyCodeLine{\ \ cursor\ =\ await\ cursor.continue();}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15401}{}\doxysubsection{\texorpdfstring{Async iterators}{Async iterators}}\label{md_node__modules_2idb_2README_autotoc_md15401}
Async iterator support isn\textquotesingle{}t included by default (Edge doesn\textquotesingle{}t support them). To include them, import {\ttfamily idb/with-\/async-\/ittr} instead of {\ttfamily idb} (this increases the library size to \texorpdfstring{$\sim$}{\string~}1.29kB brotli\textquotesingle{}d)\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{import\ \{\ openDB\ \}\ from\ 'idb/with-\/async-\/ittr';}

\end{DoxyCode}


Or {\ttfamily \href{https://cdn.jsdelivr.net/npm/idb}{\texttt{ https\+://cdn.\+jsdelivr.\+net/npm/idb}}@7/build/umd-\/with-\/async-\/ittr.\+js} if you\textquotesingle{}re using the non-\/module version.

Now you can iterate over stores, indexes, and cursors\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ tx\ =\ db.transaction(storeName);}
\DoxyCodeLine{}
\DoxyCodeLine{for\ await\ (const\ cursor\ of\ tx.store)\ \{}
\DoxyCodeLine{\ \ //\ …}
\DoxyCodeLine{\}}

\end{DoxyCode}


Each yielded object is an {\ttfamily IDBCursor}. You can optionally use the advance methods to skip items (within an async iterator they return void)\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ tx\ =\ db.transaction(storeName);}
\DoxyCodeLine{}
\DoxyCodeLine{for\ await\ (const\ cursor\ of\ tx.store)\ \{}
\DoxyCodeLine{\ \ console.log(cursor.value);}
\DoxyCodeLine{\ \ //\ Skip\ the\ next\ item}
\DoxyCodeLine{\ \ cursor.advance(2);}
\DoxyCodeLine{\}}

\end{DoxyCode}


If you don\textquotesingle{}t manually advance the cursor, {\ttfamily cursor.\+continue()} is called for you.

Stores and indexes also have an {\ttfamily iterate} method which has the same signature as {\ttfamily open\+Cursor}, but returns an async iterator\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ index\ =\ db.transaction('books').store.index('author');}
\DoxyCodeLine{}
\DoxyCodeLine{for\ await\ (const\ cursor\ of\ index.iterate('Douglas\ Adams'))\ \{}
\DoxyCodeLine{\ \ console.log(cursor.value);}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15402}{}\doxysection{\texorpdfstring{Examples}{Examples}}\label{md_node__modules_2idb_2README_autotoc_md15402}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15403}{}\doxysubsection{\texorpdfstring{Keyval store}{Keyval store}}\label{md_node__modules_2idb_2README_autotoc_md15403}
This is very similar to {\ttfamily local\+Storage}, but async. If this is {\itshape all} you need, you may be interested in \href{https://www.npmjs.com/package/idb-keyval}{\texttt{ idb-\/keyval}}. You can always upgrade to this library later.


\begin{DoxyCode}{0}
\DoxyCodeLine{import\ \{\ openDB\ \}\ from\ 'idb';}
\DoxyCodeLine{}
\DoxyCodeLine{const\ dbPromise\ =\ openDB('keyval-\/store',\ 1,\ \{}
\DoxyCodeLine{\ \ upgrade(db)\ \{}
\DoxyCodeLine{\ \ \ \ db.createObjectStore('keyval');}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\});}
\DoxyCodeLine{}
\DoxyCodeLine{export\ async\ function\ get(key)\ \{}
\DoxyCodeLine{\ \ return\ (await\ dbPromise).get('keyval',\ key);}
\DoxyCodeLine{\}}
\DoxyCodeLine{export\ async\ function\ set(key,\ val)\ \{}
\DoxyCodeLine{\ \ return\ (await\ dbPromise).put('keyval',\ val,\ key);}
\DoxyCodeLine{\}}
\DoxyCodeLine{export\ async\ function\ del(key)\ \{}
\DoxyCodeLine{\ \ return\ (await\ dbPromise).delete('keyval',\ key);}
\DoxyCodeLine{\}}
\DoxyCodeLine{export\ async\ function\ clear()\ \{}
\DoxyCodeLine{\ \ return\ (await\ dbPromise).clear('keyval');}
\DoxyCodeLine{\}}
\DoxyCodeLine{export\ async\ function\ keys()\ \{}
\DoxyCodeLine{\ \ return\ (await\ dbPromise).getAllKeys('keyval');}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15404}{}\doxysubsection{\texorpdfstring{Article store}{Article store}}\label{md_node__modules_2idb_2README_autotoc_md15404}

\begin{DoxyCode}{0}
\DoxyCodeLine{import\ \{\ openDB\ \}\ from\ 'idb/with-\/async-\/ittr.js';}
\DoxyCodeLine{}
\DoxyCodeLine{async\ function\ demo()\ \{}
\DoxyCodeLine{\ \ const\ db\ =\ await\ openDB('Articles',\ 1,\ \{}
\DoxyCodeLine{\ \ \ \ upgrade(db)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ //\ Create\ a\ store\ of\ objects}
\DoxyCodeLine{\ \ \ \ \ \ const\ store\ =\ db.createObjectStore('articles',\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ //\ The\ 'id'\ property\ of\ the\ object\ will\ be\ the\ key.}
\DoxyCodeLine{\ \ \ \ \ \ \ \ keyPath:\ 'id',}
\DoxyCodeLine{\ \ \ \ \ \ \ \ //\ If\ it\ isn't\ explicitly\ set,\ create\ a\ value\ by\ auto\ incrementing.}
\DoxyCodeLine{\ \ \ \ \ \ \ \ autoIncrement:\ true,}
\DoxyCodeLine{\ \ \ \ \ \ \});}
\DoxyCodeLine{\ \ \ \ \ \ //\ Create\ an\ index\ on\ the\ 'date'\ property\ of\ the\ objects.}
\DoxyCodeLine{\ \ \ \ \ \ store.createIndex('date',\ 'date');}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \});}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ //\ Add\ an\ article:}
\DoxyCodeLine{\ \ await\ db.add('articles',\ \{}
\DoxyCodeLine{\ \ \ \ title:\ 'Article\ 1',}
\DoxyCodeLine{\ \ \ \ date:\ new\ Date('2019-\/01-\/01'),}
\DoxyCodeLine{\ \ \ \ body:\ '…',}
\DoxyCodeLine{\ \ \});}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ //\ Add\ multiple\ articles\ in\ one\ transaction:}
\DoxyCodeLine{\ \ \{}
\DoxyCodeLine{\ \ \ \ const\ tx\ =\ db.transaction('articles',\ 'readwrite');}
\DoxyCodeLine{\ \ \ \ await\ Promise.all([}
\DoxyCodeLine{\ \ \ \ \ \ tx.store.add(\{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ title:\ 'Article\ 2',}
\DoxyCodeLine{\ \ \ \ \ \ \ \ date:\ new\ Date('2019-\/01-\/01'),}
\DoxyCodeLine{\ \ \ \ \ \ \ \ body:\ '…',}
\DoxyCodeLine{\ \ \ \ \ \ \}),}
\DoxyCodeLine{\ \ \ \ \ \ tx.store.add(\{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ title:\ 'Article\ 3',}
\DoxyCodeLine{\ \ \ \ \ \ \ \ date:\ new\ Date('2019-\/01-\/02'),}
\DoxyCodeLine{\ \ \ \ \ \ \ \ body:\ '…',}
\DoxyCodeLine{\ \ \ \ \ \ \}),}
\DoxyCodeLine{\ \ \ \ \ \ tx.done,}
\DoxyCodeLine{\ \ \ \ ]);}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ //\ Get\ all\ the\ articles\ in\ date\ order:}
\DoxyCodeLine{\ \ console.log(await\ db.getAllFromIndex('articles',\ 'date'));}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ //\ Add\ 'And,\ happy\ new\ year!'\ to\ all\ articles\ on\ 2019-\/01-\/01:}
\DoxyCodeLine{\ \ \{}
\DoxyCodeLine{\ \ \ \ const\ tx\ =\ db.transaction('articles',\ 'readwrite');}
\DoxyCodeLine{\ \ \ \ const\ index\ =\ tx.store.index('date');}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ for\ await\ (const\ cursor\ of\ index.iterate(new\ Date('2019-\/01-\/01')))\ \{}
\DoxyCodeLine{\ \ \ \ \ \ const\ article\ =\ \{\ ...cursor.value\ \};}
\DoxyCodeLine{\ \ \ \ \ \ article.body\ +=\ '\ And,\ happy\ new\ year!';}
\DoxyCodeLine{\ \ \ \ \ \ cursor.update(article);}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ await\ tx.done;}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{md_node__modules_2idb_2README_autotoc_md15405}{}\doxysection{\texorpdfstring{Type\+Script}{TypeScript}}\label{md_node__modules_2idb_2README_autotoc_md15405}
This library is fully typed, and you can improve things by providing types for your database\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{import\ \{\ openDB,\ DBSchema\ \}\ from\ 'idb';}
\DoxyCodeLine{}
\DoxyCodeLine{interface\ MyDB\ extends\ DBSchema\ \{}
\DoxyCodeLine{\ \ 'favourite-\/number':\ \{}
\DoxyCodeLine{\ \ \ \ key:\ string;}
\DoxyCodeLine{\ \ \ \ value:\ number;}
\DoxyCodeLine{\ \ \};}
\DoxyCodeLine{\ \ products:\ \{}
\DoxyCodeLine{\ \ \ \ value:\ \{}
\DoxyCodeLine{\ \ \ \ \ \ name:\ string;}
\DoxyCodeLine{\ \ \ \ \ \ price:\ number;}
\DoxyCodeLine{\ \ \ \ \ \ productCode:\ string;}
\DoxyCodeLine{\ \ \ \ \};}
\DoxyCodeLine{\ \ \ \ key:\ string;}
\DoxyCodeLine{\ \ \ \ indexes:\ \{\ 'by-\/price':\ number\ \};}
\DoxyCodeLine{\ \ \};}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{async\ function\ demo()\ \{}
\DoxyCodeLine{\ \ const\ db\ =\ await\ openDB<MyDB>('my-\/db',\ 1,\ \{}
\DoxyCodeLine{\ \ \ \ upgrade(db)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ db.createObjectStore('favourite-\/number');}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ const\ productStore\ =\ db.createObjectStore('products',\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ keyPath:\ 'productCode',}
\DoxyCodeLine{\ \ \ \ \ \ \});}
\DoxyCodeLine{\ \ \ \ \ \ productStore.createIndex('by-\/price',\ 'price');}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \});}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ //\ This\ works}
\DoxyCodeLine{\ \ await\ db.put('favourite-\/number',\ 7,\ 'Jen');}
\DoxyCodeLine{\ \ //\ This\ fails\ at\ compile\ time,\ as\ the\ 'favourite-\/number'\ store\ expects\ a\ number.}
\DoxyCodeLine{\ \ await\ db.put('favourite-\/number',\ 'Twelve',\ 'Jake');}
\DoxyCodeLine{\}}

\end{DoxyCode}


To define types for your database, extend {\ttfamily DBSchema} with an interface where the keys are the names of your object stores.

For each value, provide an object where {\ttfamily value} is the type of values within the store, and {\ttfamily key} is the type of keys within the store.

Optionally, {\ttfamily indexes} can contain a map of index names, to the type of key within that index.

Provide this interface when calling {\ttfamily open\+DB}, and from then on your database will be strongly typed. This also allows your IDE to autocomplete the names of stores and indexes.\hypertarget{md_node__modules_2idb_2README_autotoc_md15406}{}\doxysubsection{\texorpdfstring{Opting out of types}{Opting out of types}}\label{md_node__modules_2idb_2README_autotoc_md15406}
If you call {\ttfamily open\+DB} without providing types, your database will use basic types. However, sometimes you\textquotesingle{}ll need to interact with stores that aren\textquotesingle{}t in your schema, perhaps during upgrades. In that case you can cast.

Let\textquotesingle{}s say we were renaming the \textquotesingle{}favourite-\/number\textquotesingle{} store to \textquotesingle{}fave-\/nums\textquotesingle{}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{import\ \{\ openDB,\ DBSchema,\ IDBPDatabase\ \}\ from\ 'idb';}
\DoxyCodeLine{}
\DoxyCodeLine{interface\ MyDBV1\ extends\ DBSchema\ \{}
\DoxyCodeLine{\ \ 'favourite-\/number':\ \{\ key:\ string;\ value:\ number\ \};}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{interface\ MyDBV2\ extends\ DBSchema\ \{}
\DoxyCodeLine{\ \ 'fave-\/num':\ \{\ key:\ string;\ value:\ number\ \};}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{const\ db\ =\ await\ openDB<MyDBV2>('my-\/db',\ 2,\ \{}
\DoxyCodeLine{\ \ async\ upgrade(db,\ oldVersion)\ \{}
\DoxyCodeLine{\ \ \ \ //\ Cast\ a\ reference\ of\ the\ database\ to\ the\ old\ schema.}
\DoxyCodeLine{\ \ \ \ const\ v1Db\ =\ db\ as\ unknown\ as\ IDBPDatabase<MyDBV1>;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ if\ (oldVersion\ <\ 1)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ v1Db.createObjectStore('favourite-\/number');}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ if\ (oldVersion\ <\ 2)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ const\ store\ =\ v1Db.createObjectStore('favourite-\/number');}
\DoxyCodeLine{\ \ \ \ \ \ store.name\ =\ 'fave-\/num';}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\});}

\end{DoxyCode}


You can also cast to a typeless database by omitting the type, eg {\ttfamily db as IDBPDatabase}.

Note\+: Types like {\ttfamily IDBPDatabase} are used by Type\+Script only. The implementation uses proxies under the hood.\hypertarget{md_node__modules_2idb_2README_autotoc_md15407}{}\doxysection{\texorpdfstring{Developing}{Developing}}\label{md_node__modules_2idb_2README_autotoc_md15407}

\begin{DoxyCode}{0}
\DoxyCodeLine{npm\ run\ dev}

\end{DoxyCode}


This will also perform type testing.

To test, navigate to {\ttfamily build/test/} in a browser. You\textquotesingle{}ll need to set up a \href{https://www.npmjs.com/package/serve}{\texttt{ basic web server}} for this. 