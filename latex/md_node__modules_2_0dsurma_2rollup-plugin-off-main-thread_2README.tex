\chapter{rollup-\/plugin-\/off-\/main-\/thread}
\hypertarget{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README}{}\label{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README}\index{rollup-\/plugin-\/off-\/main-\/thread@{rollup-\/plugin-\/off-\/main-\/thread}}
\label{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2540}%
\Hypertarget{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2540}%
 Use Rollup with workers and ES6 modules {\itshape today}.


\begin{DoxyCode}{0}
\DoxyCodeLine{\$\ npm\ install\ -\/-\/save\ @surma/rollup-\/plugin-\/off-\/main-\/thread}

\end{DoxyCode}


Workers are Java\+Script’s version of threads. \href{https://dassur.ma/things/when-workers}{\texttt{ Workers are important to use}} as the main thread is already overloaded, especially on slower or older devices.

This plugin takes care of shimming module support in workers and allows you to use {\ttfamily new Worker()}.

OMT is the result of merging loadz0r and workz0r.\hypertarget{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2541}{}\doxysection{\texorpdfstring{Usage}{Usage}}\label{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2541}
I set up \href{https://gist.github.com/surma/a02db7b53eb3e7870bf539b906ff6ff6}{\texttt{ a gist}} to show a full setup with OMT.\hypertarget{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2542}{}\doxysubsection{\texorpdfstring{Config}{Config}}\label{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2542}

\begin{DoxyCode}{0}
\DoxyCodeLine{//\ rollup.config.js}
\DoxyCodeLine{import\ OMT\ from\ "{}@surma/rollup-\/plugin-\/off-\/main-\/thread"{};}
\DoxyCodeLine{}
\DoxyCodeLine{export\ default\ \{}
\DoxyCodeLine{\ \ input:\ ["{}src/main.js"{}],}
\DoxyCodeLine{\ \ output:\ \{}
\DoxyCodeLine{\ \ \ \ dir:\ "{}dist"{},}
\DoxyCodeLine{\ \ \ \ //\ You\ \_must\_\ use\ either\ “amd”\ or\ “esm”\ as\ your\ format.}
\DoxyCodeLine{\ \ \ \ //\ But\ note\ that\ only\ very\ few\ browsers\ have\ native\ support\ for}
\DoxyCodeLine{\ \ \ \ //\ modules\ in\ workers.}
\DoxyCodeLine{\ \ \ \ format:\ "{}amd"{}}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\ \ plugins:\ [OMT()]}
\DoxyCodeLine{\};}

\end{DoxyCode}
\hypertarget{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2543}{}\doxysubsection{\texorpdfstring{Auto bundling}{Auto bundling}}\label{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2543}
In your project\textquotesingle{}s code use a module-\/relative path via {\ttfamily new URL} to include a Worker\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ worker\ =\ new\ Worker(new\ URL("{}worker.js"{},\ import.meta.url),\ \{}
\DoxyCodeLine{\ \ type:\ "{}module"{}}
\DoxyCodeLine{\});}

\end{DoxyCode}


This will just work.

If required, the plugin also supports plain literal paths\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ worker\ =\ new\ Worker("{}./worker.js"{},\ \{\ type:\ "{}module"{}\ \});}

\end{DoxyCode}


However, those are less portable\+: in Rollup they would result in module-\/relative path, but if used directly in the browser, they\textquotesingle{}ll be relative to the document URL instead.

Hence, they\textquotesingle{}re deprecated and {\ttfamily new URL} pattern is encouraged instead for portability.\hypertarget{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2544}{}\doxysubsection{\texorpdfstring{Importing workers as URLs}{Importing workers as URLs}}\label{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2544}
If your worker constructor doesn\textquotesingle{}t match {\ttfamily worker\+Regexp} (see options below), you might find it easier to import the worker as a URL. In your project\textquotesingle{}s code\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{import\ workerURL\ from\ "{}omt:./worker.js"{};}
\DoxyCodeLine{import\ paintWorkletURL\ from\ "{}omt:./paint-\/worklet.js"{};}
\DoxyCodeLine{}
\DoxyCodeLine{const\ worker\ =\ new\ Worker(workerURL,\ \{\ name:\ "{}main-\/worker"{}\ \});}
\DoxyCodeLine{CSS.paintWorklet.addModule(paintWorkletURL);}

\end{DoxyCode}


{\ttfamily ./worker.js} and {\ttfamily ./paint-\/worklet.js} will be added to the output as chunks.\hypertarget{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2545}{}\doxysection{\texorpdfstring{Options}{Options}}\label{md_node__modules_2_0dsurma_2rollup-plugin-off-main-thread_2README_autotoc_md2545}

\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ //\ ...}
\DoxyCodeLine{\ \ plugins:\ [OMT(options)];}
\DoxyCodeLine{\}}

\end{DoxyCode}



\begin{DoxyItemize}
\item {\ttfamily loader}\+: A string containing the EJS template for the amd loader. If {\ttfamily undefined}, OMT will use {\ttfamily loader.\+ejs}.
\item {\ttfamily use\+Eval}\+: Use {\ttfamily fetch()} + {\ttfamily eval()} to load dependencies instead of {\ttfamily \texorpdfstring{$<$}{<}script\texorpdfstring{$>$}{>}} tags and {\ttfamily import\+Scripts()}. {\itshape This is not CSP compliant, but is required if you want to use dynamic imports in Service\+Worker}.
\item {\ttfamily worker\+Regexp}\+: A Reg\+Exp to find {\ttfamily new Workers()} calls. The second capture group {\itshape must} capture the provided file name without the quotes.
\item {\ttfamily amd\+Function\+Name}\+: Function name to use instead of AMD’s {\ttfamily define}.
\item {\ttfamily prepend\+Loader}\+: A function that determines whether the loader code should be prepended to a certain chunk. Should return true if the load is suppsoed to be prepended.
\item {\ttfamily url\+Loader\+Scheme}\+: Scheme to use when importing workers as URLs. If {\ttfamily undefined}, OMT will use {\ttfamily "{}omt"{}}.
\end{DoxyItemize}

\DoxyHorRuler{0}


License Apache-\/2.\+0 